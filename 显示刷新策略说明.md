# 显示刷新策略说明

## 概述

为STM32F103C8T6智能语音桌面助手项目优化了显示刷新逻辑，实现了分层刷新策略，确保时间变化时及时释放Flash防止堵塞。

## 刷新策略

### 1. 时间刷新 (1秒)
- **刷新频率**: 每秒一次
- **处理方式**: 立即处理，避免Flash堵塞
- **资源管理**: 使用栈上临时缓冲区，函数结束时自动释放
- **触发方式**: 
  - 定时触发 (task_show任务)
  - 强制触发 (语音指令)

### 2. 天气刷新 (1小时)
- **刷新频率**: 每小时一次
- **处理方式**: 异步处理，不阻塞时间刷新
- **资源管理**: 缓存天气数据，减少网络请求
- **触发方式**:
  - 定时触发 (task_wifi任务)
  - 强制触发 (语音指令"刷新")

### 3. 背景刷新 (1小时)
- **刷新频率**: 每小时一次
- **处理方式**: 异步处理，使用RLE解压缩
- **资源管理**: 临时解压缩，立即显示后释放
- **触发方式**:
  - 定时触发 (task_wifi任务)
  - 强制触发 (语音指令"更换图片")

## 技术实现

### 文件结构
```
Core/Inc/display_manager.h     - 显示管理模块头文件
Core/Src/display_manager.c     - 显示管理模块实现
```

### 核心特性

#### 1. 分层刷新
```c
typedef enum {
    DisplayRefresh_Time = 0x01,      // 时间刷新 (1秒)
    DisplayRefresh_Weather = 0x02,   // 天气刷新 (1小时)
    DisplayRefresh_Background = 0x04 // 背景刷新 (1小时)
} DisplayRefreshType;
```

#### 2. 事件驱动
- 使用FreeRTOS事件标志组
- 支持强制刷新和定时刷新
- 非阻塞事件处理

#### 3. 资源管理
- **时间刷新**: 立即处理，栈上临时缓冲区
- **天气刷新**: 缓存数据，减少网络请求
- **背景刷新**: 临时解压缩，立即释放

### 任务分工

#### task_show (时间刷新任务)
```c
void task_show(void *argument)
{
    for(;;) {
        // 每秒触发时间刷新
        display_manager_force_refresh(DisplayRefresh_Time);
        osDelay(1000);
    }
}
```

#### task_wifi (天气和背景刷新任务)
```c
void task_wifi(void *argument)
{
    for(;;) {
        // 每小时获取天气信息
        if (current_time - last_weather_fetch >= 3600000) {
            weather_fetch_now(g_esp, 5000);
            display_manager_force_refresh(DisplayRefresh_Weather);
        }
        
        // 每小时刷新背景
        if (current_time - last_background_refresh >= 3600000) {
            display_manager_force_refresh(DisplayRefresh_Background);
        }
        
        osDelay(60000); // 每分钟检查一次
    }
}
```

#### display_manager_task (显示管理任务)
```c
void display_manager_task(void *argument)
{
    for(;;) {
        // 处理定时刷新
        // 处理强制刷新事件
        // 更新显示内容
        osDelay(100);
    }
}
```

## 优化特性

### 1. Flash释放机制
- **时间变化**: 立即处理，避免Flash堵塞
- **背景切换**: 临时解压缩，立即释放
- **内存管理**: 使用栈上缓冲区，自动释放

### 2. 性能优化
- **分层处理**: 时间、天气、背景独立刷新
- **事件驱动**: 减少轮询，降低CPU占用
- **缓存机制**: 减少重复计算和网络请求

### 3. 资源保护
- **非阻塞**: 时间刷新不等待其他操作
- **优先级**: 时间刷新优先级最高
- **错误处理**: 网络失败时降级显示

## 使用示例

### 基本使用
```c
// 初始化显示管理
display_manager_init();

// 强制刷新时间
display_manager_force_refresh(DisplayRefresh_Time);

// 强制刷新天气
display_manager_force_refresh(DisplayRefresh_Weather);

// 强制刷新背景
display_manager_force_refresh(DisplayRefresh_Background);

// 组合刷新
display_manager_force_refresh(DisplayRefresh_Time | DisplayRefresh_Weather);
```

### 语音指令集成
```c
case VoiceCmd_Refresh:
    // 刷新所有内容
    display_manager_force_refresh(DisplayRefresh_Time | DisplayRefresh_Weather | DisplayRefresh_Background);
    break;

case VoiceCmd_ChangeImage:
    // 只刷新背景
    display_manager_force_refresh(DisplayRefresh_Background);
    break;
```

## 配置参数

### 刷新间隔
```c
#define TIME_REFRESH_INTERVAL     1000    // 1秒
#define WEATHER_REFRESH_INTERVAL  3600000 // 1小时
#define BACKGROUND_REFRESH_INTERVAL 3600000 // 1小时
```

### 任务配置
```c
// 显示管理任务
.stack_size = 512 * 4,  // 2KB栈空间
.priority = osPriorityNormal,

// 时间刷新任务
.stack_size = 128 * 4,  // 512B栈空间
.priority = osPriorityAboveNormal,

// WiFi任务
.stack_size = 128 * 4,  // 512B栈空间
.priority = osPriorityNormal,
```

## 故障排除

### 时间显示不更新
- 检查task_show任务是否正常运行
- 确认DS1302模块工作正常
- 检查事件标志组是否正常

### 天气不刷新
- 检查WiFi连接状态
- 确认weather模块初始化
- 检查task_wifi任务运行状态

### 背景不切换
- 检查picture_rle模块
- 确认RLE解压缩函数正常
- 检查OLED显示驱动

### Flash堵塞
- 确认使用栈上临时缓冲区
- 检查函数及时返回
- 避免长时间占用Flash资源

## 扩展功能

### 可配置刷新间隔
- 支持运行时修改刷新间隔
- 支持不同模式下的刷新策略
- 支持用户自定义刷新频率

### 显示优先级
- 支持显示内容优先级管理
- 支持紧急信息覆盖显示
- 支持显示队列管理

### 节能模式
- 支持低功耗显示模式
- 支持屏幕休眠功能
- 支持按需刷新机制
