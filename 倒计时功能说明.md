# 倒计时功能说明

## 功能概述

为STM32F103C8T6智能语音桌面助手项目添加了倒计时功能，支持语音控制倒计时启动、停止和状态查询。

## 语音指令

### 启动倒计时
- **"倒计时5分钟"** 或 **"倒计时五分钟"** 或 **"5分钟倒计时"**
- **"倒计时10分钟"** 或 **"倒计时十分钟"** 或 **"10分钟倒计时"**

### 查询倒计时状态
- **"倒计时状态"** 或 **"倒计时查询"** 或 **"倒计时还剩"**

### 停止倒计时
- **"停止倒计时"** 或 **"取消倒计时"** 或 **"倒计时停止"**

## 功能特性

### 1. 精确计时
- 使用HAL_GetTick()获取系统时间，精度为毫秒级
- 每秒检查一次倒计时状态
- 支持秒级精度的时间查询

### 2. LED指示
- **倒计时进行中**: PC13 LED慢速闪烁（每秒切换一次）
- **倒计时结束**: PC13 LED快速闪烁10次
- **倒计时停止**: PC13 LED熄灭

### 3. 语音反馈
- 启动倒计时时自动语音确认
- 倒计时结束时自动语音提示
- 支持实时查询剩余时间

### 4. 状态管理
- 支持同时只能运行一个倒计时
- 防止重复启动倒计时
- 支持手动停止倒计时

## 技术实现

### 文件结构
```
Core/Inc/countdown.h          - 倒计时模块头文件
Core/Src/countdown.c          - 倒计时模块实现
Core/Src/countdown_test.c     - 倒计时测试代码
```

### 核心函数
```c
// 初始化倒计时模块
void countdown_init(void);

// 启动倒计时
bool countdown_start(uint32_t minutes, CountdownCallback_t callback);

// 停止倒计时
void countdown_stop(void);

// 获取倒计时状态
CountdownState countdown_get_state(void);

// 获取剩余时间（秒）
uint32_t countdown_get_remaining_seconds(void);

// 获取剩余时间（分钟）
uint32_t countdown_get_remaining_minutes(void);
```

### 状态枚举
```c
typedef enum {
    CountdownState_Stopped = 0,    // 停止状态
    CountdownState_Running,        // 运行状态
    CountdownState_Finished        // 结束状态
} CountdownState;
```

## 使用示例

### 基本使用
1. 说"倒计时5分钟"启动5分钟倒计时
2. 说"倒计时状态"查询剩余时间
3. 说"停止倒计时"手动停止倒计时

### 编程使用
```c
// 初始化倒计时模块
countdown_init();

// 启动10分钟倒计时
if (countdown_start(10, NULL)) {
    // 倒计时启动成功
}

// 查询剩余时间
uint32_t remaining_minutes = countdown_get_remaining_minutes();
uint32_t remaining_seconds = countdown_get_remaining_seconds() % 60;

// 停止倒计时
countdown_stop();
```

## 集成说明

### FreeRTOS任务
- 倒计时模块在独立的FreeRTOS任务中运行
- 任务优先级设置为Normal
- 任务栈大小：256 * 4 = 1024字节

### 语音集成
- 通过voice.c模块解析语音指令
- 支持多种语音指令变体
- 自动发送语音反馈

### LED集成
- 使用PC13（板载LED）进行状态指示
- 低电平点亮LED
- 不同状态对应不同的闪烁模式

## 注意事项

1. **时间精度**: 使用HAL_GetTick()获取时间，受系统时钟影响
2. **内存使用**: 倒计时任务占用约1KB栈空间
3. **并发限制**: 同时只能运行一个倒计时
4. **语音识别**: 需要VC02模块正确配置和连接
5. **LED指示**: PC13 LED会用于倒计时状态指示

## 扩展功能

### 可扩展的指令
- 支持更多时间长度（1分钟、30分钟等）
- 支持倒计时暂停/恢复功能
- 支持倒计时提醒功能

### 可扩展的指示
- 使用OLED显示倒计时信息
- 添加蜂鸣器声音提示
- 支持多种LED闪烁模式

## 测试方法

1. 编译并烧录程序到STM32
2. 通过语音说"倒计时5分钟"
3. 观察PC13 LED开始慢速闪烁
4. 说"倒计时状态"查询剩余时间
5. 等待倒计时结束，观察LED快速闪烁
6. 说"停止倒计时"可以手动停止

## 故障排除

### 倒计时不启动
- 检查语音识别是否正确
- 确认倒计时模块已初始化
- 检查是否已有倒计时在运行

### LED不闪烁
- 检查PC13 GPIO配置
- 确认LED为低电平点亮
- 检查倒计时任务是否正常运行

### 语音无响应
- 检查VC02模块连接
- 确认UART通信正常
- 检查语音指令是否正确
